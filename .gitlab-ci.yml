###############################################################################
# Copyright (c) 2022, Lawrence Livermore National Security, LLC and RADIUSS
# project contributors. See the COPYRIGHT file for details.
#
# SPDX-License-Identifier: (MIT)
###############################################################################

###############################################################################
# General GitLab pipelines configurations for supercomputers and Linux clusters
# at Lawrence Livermore National Laboratory (LLNL).
#
# This entire pipeline is LLNL-specific
# #############################################################################

# We organize the CI on Gitlab in sub-pipelines. Each sub-pipeline correspond
# to a test phase on a given machine. This design is simpler and more scalable
# than doing the same with stages.

# We start with custom configuration, local to the project.
include:
  - local: .gitlab/custom-variables.yml

# The stages in the top-level pipeline described here correspond to high level
# steps in the testing workflow.
# TODO: rehabilitate multi-project and branch radiuss-spack-testing.
stages:
  - build-and-test
  - multi-project # unused so far
  - radiuss-spack-testing # unused so far

# Template for jobs triggering a build-and-test  sub-pipelines:
.build-and-test:
  stage: build-and-test
  trigger:
    include:
      - local: '.gitlab/custom-jobs.yml'
      - project: 'radiuss/radiuss-shared-ci'
        ref: main
        file: '${CI_JOB_NAME}.yml'
      - local: '.gitlab/${CI_JOB_NAME}-extra.yml'
    strategy: depend
    forward:
      pipeline_variables: true

# Trigger a pipeline for ruby, corona and lassen
ruby-build-and-test:
  extends: [.build-and-test]

corona-build-and-test:
  extends: [.build-and-test]

lassen-build-and-test:
  extends: [.build-and-test]

# If testing develop branch, trigger CHAI pipeline with this version of Umpire.
# TODO: Once Spack allows to clone a specific commit on demand, then point to the exact commit.
#       This will prevent from sticking to a branch (here develop).
# trigger-chai:
#  stage: multi-project
#  rules:
#    - if: '$CI_COMMIT_BRANCH == "develop" || $MULTI_PROJECT == "ON"' #run only if ...
#  variables:
#    UPDATE_UMPIRE: develop
#  trigger:
#    project: radiuss/chai
#    branch: develop
#    strategy: depend
